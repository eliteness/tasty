<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thena Strategy</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;600;700&family=Merriweather:wght@700;900&display=swap');

:root { 
    --bg-body: #FFFFFF; 
    --bg-card: #FFFFFF;
    --bg-panel: #f0f0f0;
    --text-main: #000000; 
    --text-sub: #555555;
    --border: #000000;
    --accent-green: #00aa00;
    --accent-red: #cc0000;
    --chart-grid: #f0f0f0;
}

[data-theme="dark"] {
    --bg-body: #111111; 
    --bg-card: #1a1a1a;
    --bg-panel: #2a2a2a;
    --text-main: #ffffff; 
    --text-sub: #aaaaaa;
    --border: #555555;
    --accent-green: #00e599;
    --accent-red: #ff4444;
    --chart-grid: #333333;
}

* { box-sizing: border-box; margin: 0; padding: 0; transition: background 0.3s, color 0.3s, border-color 0.3s; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; }

.header-row { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: transparent; }
.logo-container { display: flex; align-items: center; gap: 15px; }
.top-logo { height: 50px; width: auto; display: block; }
[data-theme="dark"] .top-logo { filter: invert(1); }
.logo-text { font-family: 'Merriweather', serif; font-weight: 900; font-size: 24px; letter-spacing: 1px; line-height: 1; margin-top: 4px; }
.header-right { display: flex; gap: 15px; align-items: center; }

.theme-btn {
    background: var(--bg-card); border: 2px solid var(--border); color: var(--text-main);
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: 0.2s; flex-shrink: 0;
}
.theme-btn:hover { background: var(--text-main); color: var(--bg-body); }

.connect-btn { 
    background: var(--bg-card); color: var(--text-main); padding: 10px 24px; border: 2px solid var(--border); 
    font-family: 'Courier Prime', monospace; font-weight: 700; cursor: pointer; transition: 0.2s;
    display: flex; align-items: center; justify-content: center; white-space: nowrap;
}
.connect-btn:hover { background: var(--text-main); color: var(--bg-body); transform: translateY(-2px); box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }

.tab-container { display: flex; justify-content: center; gap: 0; margin-top: 20px; border-bottom: 2px solid var(--border); width: fit-content; margin: 20px auto 40px auto; }
.tab-btn { background: var(--bg-card); color: var(--text-main); border: 2px solid var(--border); border-bottom: none; padding: 10px 40px; font-family: 'Courier Prime', monospace; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 14px; margin: 0 5px; position: relative; top: 2px; transition: background 0.2s; }
.tab-btn:hover { background: var(--bg-panel); }
.tab-btn.active { background: var(--text-main); color: var(--bg-body); border-color: var(--border); }

.main-container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; flex: 1; }
.view-section { display: none; }
.view-section.active { display: block; }

.swap-view-grid { display: flex; justify-content: center; align-items: flex-start; gap: 50px; flex-wrap: wrap; }
.swap-column { flex: 1; max-width: 450px; min-width: 320px; }
.swap-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.swap-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 18px; }
.settings-icon { cursor: pointer; width: 24px; height: 24px; transition: transform 0.3s ease; }
.settings-icon:hover { transform: rotate(90deg); }

[data-theme="dark"] .token-icon[src*="thenastrat"] { filter: invert(1); }
input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }

.settings-panel { background: var(--bg-panel); border: 2px solid var(--border); padding: 15px; margin-bottom: 15px; display: none; }
.settings-panel.open { display: block; }
.slip-label { font-family: 'Courier Prime', monospace; font-size: 12px; margin-bottom: 8px; font-weight: bold; }
.slip-options { display: flex; gap: 8px; }
.slip-btn { flex: 1; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); font-family: 'Courier Prime', monospace; font-size: 12px; padding: 6px; cursor: pointer; }
.slip-btn.active { background: var(--text-main); color: var(--bg-body); }
.slip-input { width: 60px; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); padding: 6px; font-family: 'Courier Prime', monospace; font-size: 12px; text-align: center; }

.trade-box { background: var(--bg-card); border: 2px solid var(--border); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; height: 160px; position: relative; margin-bottom: 10px; }
.trade-top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.trade-label { font-family: 'Courier Prime', monospace; font-size: 14px; }
.balance-display { font-family: 'Courier Prime', monospace; font-size: 11px; color: var(--text-sub); display: flex; gap: 5px; align-items: center; }

.max-btn {
    background: transparent; 
    border: 1px solid var(--text-main); 
    color: var(--text-main);
    padding: 2px 6px;
    cursor: pointer;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    margin-left: 6px;
    transition: all 0.2s ease;
}
.max-btn:hover {
    background: var(--text-main);
    color: var(--bg-body);
    transform: translateY(-1px);
}

.trade-content { display: flex; justify-content: space-between; align-items: center; }
.token-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.token-icon { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); }
.token-symbol { font-family: 'Merriweather', serif; font-weight: 900; font-size: 20px; }
.token-name { font-family: 'Courier Prime', monospace; font-size: 11px; color: var(--text-sub); }

.input-amount { width: 100%; border: none; background: transparent; color: var(--text-main); font-family: 'Merriweather', serif; font-size: 24px; font-weight: 900; text-align: right; outline: none; padding: 0; }
.usd-value { font-family: 'Courier Prime', monospace; font-size: 12px; color: var(--text-sub); text-align: right; margin-top: 4px; }
.arrow-wrapper { position: relative; height: 20px; margin-bottom: 10px; }
.swap-arrow-btn { width: 36px; height: 36px; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); border-radius: 50%; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 5; transition: transform 0.2s; }
.swap-arrow-btn:hover { background: var(--text-main); color: var(--bg-body); transform: translate(-50%, -50%) rotate(180deg); }
.receipt-area { font-family: 'Courier Prime', monospace; font-size: 11px; margin: 15px 0; border-top: 1px dashed var(--border); padding-top: 10px; }
.receipt-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

.action-btn { width: 100%; background: var(--bg-card); color: var(--text-main); border: 2px solid var(--border); padding: 16px; font-family: 'Merriweather', serif; font-weight: 900; font-size: 16px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
.action-btn:hover { background: var(--text-main); color: var(--bg-body); }
.action-btn:disabled { background: #ccc !important; cursor: not-allowed; }

.summary-column { flex: 1; max-width: 450px; min-width: 320px; }
.info-card { border: 2px solid var(--border); background: var(--bg-card); padding: 30px; }
.info-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
.pair-label { font-family: 'Merriweather', serif; font-weight: 900; font-size: 22px; }
.date-label { font-family: 'Courier Prime', monospace; font-size: 11px; margin-top: 6px; }
.price-large { font-family: 'Merriweather', serif; font-weight: 900; font-size: 42px; text-align: right; line-height: 1; }
.price-change { font-family: 'Courier Prime', monospace; font-size: 16px; text-align: right; color: var(--accent-green); margin-top: 8px; font-weight: bold; }
.mini-grid { display: flex; gap: 15px; margin-bottom: 25px; }
.mini-box { border: 1px solid var(--border); padding: 15px; flex: 1; }
.mini-label { font-family: 'Courier Prime', monospace; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
.mini-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 20px; }
.dashed-line { border-top: 1px dashed var(--border); margin: 25px 0; }
.comp-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 14px; text-transform: uppercase; margin-bottom: 15px; }
.comp-row { margin-bottom: 16px; }
.comp-text { display: flex; justify-content: space-between; font-family: 'Courier Prime', monospace; font-size: 12px; font-weight: 700; margin-bottom: 6px; }
.comp-bar { width: 100%; height: 16px; border: 1px solid var(--border); background: var(--bg-card); padding: 2px; }
.comp-fill { height: 100%; background: var(--text-main); width: 0%; transition: width 1s; }
.comp-fill.striped { background: repeating-linear-gradient(45deg, var(--text-main), var(--text-main) 2px, var(--bg-card) 2px, var(--bg-card) 6px); }

.dash-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
.dash-col-left { display: flex; flex-direction: column; gap: 20px; }
.dash-col-right { display: flex; flex-direction: column; gap: 20px; }
.chart-card { border: 2px solid var(--border); background: var(--bg-card); padding: 20px; height: 400px; display: flex; flex-direction: column; }
.chart-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
.chart-title-group h2 { font-family: 'Merriweather', serif; font-weight: 900; font-size: 24px; margin-bottom: 5px; }
.chart-subtitle { font-family: 'Courier Prime', monospace; font-size: 11px; text-transform: uppercase; }
.chart-price-display { text-align: right; }
.cp-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 32px; }
.cp-change { font-family: 'Courier Prime', monospace; font-weight: 700; color: var(--accent-red); }
.canvas-container { flex: 1; position: relative; width: 100%; }
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
.stat-card { background: var(--bg-card); border: 2px solid var(--border); padding: 20px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; min-height: 110px; }
.stat-lbl { font-family: 'Courier Prime', monospace; font-size: 13px; letter-spacing: 1px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; }
.stat-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 28px; color: var(--text-main); line-height: 1; }

.dash-card { border: 2px solid var(--border); background: var(--bg-card); padding: 25px; }
.dash-card-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 18px; margin-bottom: 5px; }
.dash-card-sub { font-family: 'Courier Prime', monospace; font-size: 11px; color: #666; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px dashed #ccc; }
.dash-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
.dash-row:last-child { border-bottom: none; }
.d-lbl { font-family: 'Courier Prime', monospace; font-weight: 700; font-size: 13px; }
.d-sub { font-size: 10px; color: #888; margin-top: 2px; font-family: 'Inter', sans-serif; }
.d-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 18px; text-align: right; }
.d-unit { font-size: 12px; font-weight: 400; color: #555; margin-left: 3px; }

.user-profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.user-status { font-family: 'Courier Prime', monospace; font-size: 10px; text-transform: uppercase; background: var(--text-main); color: var(--bg-body); padding: 3px 6px; border-radius: 2px; }
.user-status.disconnected { background: #ccc; color: #555; }
.query-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border); }
.query-toggle { display: flex; align-items: center; gap: 8px; font-family: 'Courier Prime', monospace; font-size: 12px; font-weight: 700; cursor: pointer; user-select: none; }
.query-toggle input { cursor: pointer; width: 14px; height: 14px; accent-color: var(--text-main); }
.query-input-wrap { display: none; margin-top: 10px; }
.query-input-wrap.show { display: block; }
.query-field { width: 100%; padding: 8px; border: 1px solid var(--border); background: var(--bg-panel); color: var(--text-main); font-family: 'Courier Prime', monospace; font-size: 12px; outline: none; }
.user-balance-section { text-align: center; padding: 10px 0 20px 0; }
.user-balance-lbl { font-family: 'Courier Prime', monospace; font-size: 12px; color: var(--text-sub); margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
.user-balance-big { font-family: 'Merriweather', serif; font-weight: 900; font-size: 25px; line-height: 1; }
.user-balance-sym { font-size: 16px; color: var(--text-main); font-weight: 700; margin-left: 4px; }
.address-box { background: var(--bg-card); border: 1px solid var(--border); padding: 12px; display: flex; justify-content: space-between; align-items: center; font-family: 'Courier Prime', monospace; font-size: 12px; margin-top: 5px; cursor: pointer; transition: 0.2s; overflow: hidden; }
.address-box:hover { background: var(--text-main); color: var(--bg-body); }
.copy-icon { width: 14px; height: 14px; flex-shrink: 0; }


.socials-row { 
    padding: 120px 0 15px 0; 
    
    display: flex; 
    justify-content: center; 
    gap: 50px; 
    align-items: center; 
}

.social-link { 
    display: flex; 
    flex-direction: column; 
    align-items: center;
    text-decoration: none; 
    color: var(--text-main); 
    
    width: auto; 
    height: auto; 
    border: none;
    background: transparent;
    transition: transform 0.2s; 
}

.social-link:hover { 
    transform: translateY(-3px); 
    opacity: 0.8;
}

.social-icon {
    margin-bottom: 10px;
}

.social-icon svg { 
    width: 34px;   
    height: 34px;  
    fill: currentColor; 
    display: block; 
}

.social-text { 
    display: block; 
    font-family: 'Courier Prime', monospace; 
    font-size: 12px; 
    font-weight: 700; 
    text-transform: uppercase; 
    letter-spacing: 1px;
    line-height: 1;
}

.built-on-row { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    gap: 10px; 
    
    padding: 5px 0 40px 0; 
    
    opacity: 0.8; 
    transition: opacity 0.3s; 
}
.thena-icon-sm { width: 20px; height: 20px; display: block; }
.built-text { font-family: 'Courier Prime', monospace; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

.close-btn {
    position: absolute;
    top: -8px; 
    left: -8px; 
    width: 20px;
    height: 20px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    color: var(--text-main);
    font-family: 'Courier Prime', monospace;
    font-weight: 700;
    font-size: 14px;
    line-height: 1;
    cursor: pointer;
    display: none; 
    align-items: center;
    justify-content: center;
    z-index: 1001;
    box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
}
.close-btn:hover { background: var(--accent-red); color: white; }

@media (max-width: 768px) {
    .close-btn { display: flex; } 
}

.float-badge {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    background-color: var(--bg-card); 
    border: 2px solid var(--border);
    box-shadow: 4px 4px 0 rgba(0,0,0,0.1); 
    color: var(--text-main);
    text-decoration: none;
    display: block; 
    padding: 0; 
    overflow: visible; 
    transition: transform 0.2s;
}
.float-badge:hover { transform: translateY(-2px); }

.float-badge-inner {
    position: relative;
    overflow: hidden; 
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    width: 100%;
    height: 100%;
}

.float-icon { width: 32px; height: 32px; object-fit: contain; z-index: 2; position: relative; }
.float-watermark {
    position: absolute; right: -10px; bottom: -15px; width: 80px;
    opacity: 0.1; z-index: 0; pointer-events: none; filter: grayscale(100%);
}
.float-content { display: flex; flex-direction: column; z-index: 2; position: relative; }
.float-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 13px; color: var(--text-main); }
.float-sub { font-family: 'Courier Prime', monospace; font-size: 9px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }

.ad-box {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
    z-index: 999;
    display: flex;
    flex-direction: column;
    width: 180px;
    transition: transform 0.2s;
}
.ad-box:hover { transform: translateY(-2px); }

.ad-crop-zone {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    overflow: hidden; 
    pointer-events: none;
    z-index: 0;
}
.ad-watermark {
    position: absolute; right: -20px; top: -10px; width: 100px;
    opacity: 0.08; filter: grayscale(100%); 
}

.ad-body {
    padding: 20px 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    z-index: 10; 
    overflow: visible; 
}

.ad-main-icon {
    width: 48px; height: 48px; border-radius: 50%;
    border: 2px solid var(--border); background: var(--bg-card);
    object-fit: cover;
}
.ad-title {
    font-family: 'Merriweather', serif; font-weight: 900; font-size: 13px;
    margin-top: 10px; line-height: 1.2;
}

.ad-dropdown { position: relative; display: inline-block; margin-top: 8px; width: 100%; }
.ad-drop-btn {
    font-family: 'Courier Prime', monospace; font-size: 10px;
    background: var(--text-main); color: var(--bg-body);
    font-weight: 700; text-transform: uppercase;
    border: 1px solid var(--text-main); padding: 8px 12px;
    cursor: pointer; width: 100%; display: flex; justify-content: space-between; align-items: center;
}
.ad-drop-content {
    display: none; position: absolute; top: 100%; left: 0;
    background-color: var(--bg-card); border: 2px solid var(--border);
    min-width: 100%; box-shadow: 4px 4px 0 rgba(0,0,0,0.1); z-index: 100;
}
.ad-drop-content a {
    color: var(--text-main); padding: 8px 12px; text-decoration: none;
    display: block; font-family: 'Courier Prime', monospace;
    font-size: 9px; font-weight: 700; text-transform: uppercase;
    border-bottom: 1px dashed var(--border); text-align: left;
}
.ad-drop-content a:last-child { border-bottom: none; }
.ad-drop-content a:hover { background-color: var(--bg-panel); }
.ad-dropdown:hover .ad-drop-content { display: block; }

.ad-footer {
    padding: 8px 12px;
    background: var(--bg-panel);
    border-top: 2px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    text-decoration: none;
    position: relative; z-index: 2;
}
.ad-footer-lbl {
    font-family: 'Courier Prime', monospace; font-size: 9px;
    color: var(--text-sub); font-weight: 700;
}

.mclb-logo {
    height: 20px; width: auto; display: block;
    filter: brightness(0) grayscale(100%); opacity: 0.8; transition: transform 0.2s;
}
[data-theme="dark"] .mclb-logo { filter: brightness(0) invert(1); opacity: 1; }
.ad-footer:hover .mclb-logo { transform: scale(1.1); opacity: 1; }

@media (max-width: 1024px) {
    .dash-layout { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); } 
}
@media (max-width: 768px) {
    .header-row { padding: 10px 20px; flex-direction: row; justify-content: space-between; align-items: center; gap: 0; }
    .logo-container { flex-direction: column; align-items: flex-start; align-items: center; gap: 2px; margin-bottom: 0; }
    .top-logo { height: 45px; width: auto; }
    .logo-text { font-size: 15px; font-family: 'Courier Prime', monospace; text-transform: uppercase; margin-top: 0; line-height: 1.2; }
    .header-right { width: auto; justify-content: flex-end; gap: 5px; }
    .connect-btn { padding: 10px 14px; font-size: 20px; height: 50px; }
    .theme-btn { width: 40px; height: 50px; }
    .tab-container { width: 100%; display: flex; padding: 0 10px; }
    .tab-btn { flex: 1; padding: 10px 0; font-size: 13px; text-align: center; }
    .swap-view-grid { gap: 20px; }
    .swap-column, .summary-column { min-width: 100%; max-width: 100%; }
    .stats-grid { gap: 10px; }
    .chart-header { flex-direction: column; align-items: flex-start; gap: 10px; }
    .chart-price-display { text-align: left; width: 100%; display: flex; justify-content: space-between; align-items: baseline; }
    
    .ad-box { display: flex; transform: scale(0.85); transform-origin: bottom left; left: 10px; bottom: 10px; }
    .float-badge { transform: scale(0.85); transform-origin: bottom right; right: 10px; bottom: 10px; }
}
@media (max-width: 480px) {
    .connect-btn { padding: 6px 10px; font-size: 10px; height: 34px; }
    .theme-btn { width: 34px; height: 34px; }
    .trade-box { padding: 15px; height: auto; gap: 15px; }
    .trade-content { flex-direction: column; align-items: flex-start; gap: 12px; }
    .trade-content > div:last-child { width: 100% !important; text-align: left !important; }
    .input-amount { text-align: left; font-size: 24px; margin-top: 5px; }
    .usd-value { text-align: left; }
    .swap-arrow-btn { width: 30px; height: 30px; }
    .info-card { padding: 20px; }
    .price-large { font-size: 32px; }
    .mini-grid { flex-direction: column; gap: 10px; }
    .stat-val { font-size: 22px; }
    .cp-val { font-size: 24px; }
    .chart-title-group h2 { font-size: 18px; }
    .user-balance-big { font-size: 28px; }
    .socials-row { gap: 20px; }
}


#mobileInfoBtn { 
    display: none; 
}

@media (max-width: 768px) {
    #leftAdBox, #rightBadgeBox { 
        display: none !important; 
    }

    #mobileInfoBtn.show-btn {
        display: flex !important; 
        justify-content: center; 
        align-items: center;
        width: 20px; 
        height: 20px;
        background: transparent; 
        color: var(--text-sub);
        border: 1.5px solid var(--text-sub); 
        border-radius: 50%;
        font-family: 'Merriweather', serif; 
        font-weight: 700; 
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
        margin-left: 8px; 
        transition: transform 0.2s;
    }
    #mobileInfoBtn.show-btn:active { transform: scale(0.9); }

    body.show-ads #leftAdBox {
        display: flex !important;
        position: fixed;
        top: 45%; 
        left: 50%;
        bottom: auto; 
        transform: translate(-50%, -50%); 
        z-index: 2010;
        width: 280px; 
        box-shadow: 0 0 25px rgba(0,0,0,0.5); 
    }

    body.show-ads::before {
        content: '';
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.85); 
        z-index: 2009;
        backdrop-filter: blur(4px);
    }

    body.show-ads #leftAdBox {
        display: flex !important;
        flex-direction: column;
        justify-content: space-between;
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        transform: none !important;
        border: none;
        border-radius: 0;
        max-width: none;
        z-index: 2020;
        background: var(--bg-card);
        padding: 0;
    }

    body.show-ads #leftAdBox .ad-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 400px; 
        margin: 0 auto;
        padding: 0 30px;
        position: relative; 
        z-index: 10;
    }

    body.show-ads .ad-main-icon {
        width: 100px; height: 100px; margin-bottom: 25px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    body.show-ads .ad-title {
        font-size: 24px; margin-bottom: 30px; line-height: 1.4;
    }
    body.show-ads .ad-drop-btn {
        padding: 18px 25px; font-size: 16px; letter-spacing: 1px;
    }
    body.show-ads .ad-drop-content a {
        padding: 15px 20px; font-size: 14px;
    }

    body.show-ads .ad-crop-zone {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        overflow: hidden; pointer-events: none; z-index: 0;
    }
    body.show-ads .ad-watermark {
        position: absolute; top: 50%; left: 50%;
        width: 100vw; height: auto; max-width: none;
        transform: translate(-50%, -50%); opacity: 0.1; 
    }

    body.show-ads #leftAdBox .close-btn {
        position: absolute; top: 25px; right: 25px; left: auto;
        width: 50px; height: 50px; font-size: 24px;
        background: var(--bg-panel); border: 2px solid var(--border); z-index: 2025;
    }

    body.show-ads #leftAdBox .ad-footer {
        width: 100%; padding: 30px;
        background: var(--bg-panel); border-top: 2px solid var(--border);
        display: flex; justify-content: space-between; align-items: center; z-index: 20;
    }
    body.show-ads .ad-footer-lbl { font-size: 18px !important; font-weight: 900; }
    body.show-ads .mclb-logo { height: 40px !important; width: auto; }
}

    </style>
</head>
<body>

    <div class="header-row">
        <div class="logo-container">
            <img src="thenastrat_token_logo_black.png" alt="THESTRAT" class="top-logo">
            <span class="logo-text">Thena Strategy</span>
        </div>
        <div class="header-right">
            <button class="theme-btn" onclick="toggleTheme()" id="themeBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <button id="connectBtn" class="connect-btn" onclick="connectWallet()">CONNECT WALLET</button>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('swap')">SWAP</button>
        <button class="tab-btn" onclick="switchTab('dashboard')">DASHBOARD</button>
    </div>

    <div class="main-container">

        <div id="swap-view" class="view-section active">
            <div class="swap-view-grid">
                <div class="swap-column">
                    <div class="swap-header-row">
                        <div class="swap-title">Swap</div>
                        <div class="settings-icon" onclick="toggleSettings()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </div>
                    </div>

                    <div id="settingsPanel" class="settings-panel">
                        <div class="slip-label">SLIPPAGE TOLERANCE</div>
                        <div class="slip-options">
                            <button class="slip-btn" onclick="setSlip(0.5)">0.5%</button>
                            <button class="slip-btn" onclick="setSlip(1.0)">1.0%</button>
                            <button class="slip-btn" onclick="setSlip(5.0)">5.0%</button>
                            <input type="number" id="customSlip" class="slip-input" placeholder="Custom" oninput="setCustomSlip()">
                        </div>
                    </div>

                   <div class="trade-box">
                    <div class="trade-top-row">
                        <div class="trade-label">Sell</div>
                        <div class="balance-display">
                            Balance: <span id="sBal">0</span>
                            <button class="max-btn" onclick="setMax()">MAX</button>
                        </div>
                    </div>
                    <div class="trade-content">
                       
<div class="token-info" onclick="setMode('sell')">
    <img src="" id="sIcon" class="token-icon">
    
    <div>
        <div style="display: flex; align-items: center;">
            <div class="token-symbol" id="sSym">---</div>
            <div id="mobileInfoBtn" onclick="event.stopPropagation(); toggleAds()">?</div>
        </div>
        <div class="token-name" id="sName">---</div>
    </div>
</div>

                        <div style="text-align:right; width:50%;">
                            <input type="number" id="inpAmt" class="input-amount" placeholder="0" oninput="calc()">
                            <div class="usd-value" id="sUsd">$0.00</div>
                        </div>
                    </div>
                </div>

                    <div class="arrow-wrapper">
                        <div class="swap-arrow-btn" onclick="toggleSwap()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                        </div>
                    </div>

                    <div class="trade-box">
                        <div class="trade-top-row">
                            <div class="trade-label">Buy</div>
                            <div class="balance-display">
                                Balance: <span id="bBal">0</span>
                            </div>
                        </div>
                        <div class="trade-content">
                            <div class="token-info" onclick="setMode('buy')">
                                <img src="" id="bIcon" class="token-icon">
                                <div>
                                    <div class="token-symbol" id="bSym">---</div>
                                    <div class="token-name" id="bName">---</div>
                                </div>
                            </div>
                            <div style="text-align:right; width:50%;">
                                <input type="text" id="outAmt" class="input-amount" placeholder="0" readonly>
                                <div class="usd-value" id="bUsd">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="receipt-area">
                        <div class="receipt-row"><span>Slippage</span><span id="slipDisplay">0.5%</span></div>
                        <div class="receipt-row"><span>Rate</span><span id="rateTxt">---</span></div>
                        <div class="receipt-row"><span>Quote (Inc. Fees)</span><span id="quoteTxt">---</span></div>
                    </div>

                    <button id="mainActionBtn" class="action-btn">CONNECT WALLET</button>
                </div>

                <div class="summary-column">
                    <div class="info-card">
                        <div class="info-header">
                            <div>
                                <div class="pair-label" id="cardPair">... / ...</div>
                                <div class="date-label" id="cardDate">...</div>
                            </div>
                            <div>
                                <div class="price-large" id="cardPrice">$0.0000</div>
                                <div class="price-change" id="cardChange">+0.00%</div>
                            </div>
                        </div>

                        <div class="mini-grid">
                            <div class="mini-box">
                                <div class="mini-label">Market Cap</div>
                                <div class="mini-val" id="cardFdv">---</div>
                            </div>
                            <div class="mini-box">
                                <div class="mini-label">Liquidity USD</div>
                                <div class="mini-val" id="cardLiq">---</div>
                            </div>
                        </div>

                        <div class="dashed-line"></div>

                        <div class="comp-title">Pool Composition</div>
                        <div class="comp-row">
                            <div class="comp-text"><span id="cTok1">---</span><span id="cVal1">0</span></div>
                            <div class="comp-bar"><div class="comp-fill" id="cBar1" style="width:50%"></div></div>
                        </div>
                        <div class="comp-row">
                            <div class="comp-text"><span id="cTok2">---</span><span id="cVal2">0</span></div>
                            <div class="comp-bar"><div class="comp-fill striped" id="cBar2" style="width:50%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-view" class="view-section">
            <div class="dash-layout">
                <div class="dash-col-left">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title-group">
                                <h2>eTHENA / fBOMB</h2>
                                <div class="chart-subtitle">30 Day Price Action</div>
                            </div>
                            <div class="chart-price-display">
                                <div class="cp-val" id="dashPriceVal">$0.0000</div>
                                <div class="cp-change" id="dashPriceChg">-0.00%</div>
                            </div>
                        </div>
                        <div class="canvas-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-lbl">Market Cap</div>
                            <div class="stat-val" id="barMC">$603,263</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-lbl">24h Volume</div>
                            <div class="stat-val" id="barVol">$892</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-lbl">Burned</div>
                            <div class="stat-val" id="barBurn">2.25%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-lbl">24h Change</div>
                            <div class="stat-val" id="barChg" style="color:var(--accent-red);">-1.57%</div>
                        </div>
                    </div>
                </div>

                <div class="dash-col-right">
                    <div class="dash-card">
                        <div class="dash-card-title">Treasury Holdings</div>
                        <div class="dash-card-sub">Protocol Owned Assets</div>

                        <div class="dash-row">
                            <div>
                                <div class="d-lbl">eTHENA Owned</div>
                                <div class="d-sub">Staked in Protocol</div>
                            </div>
                            <div class="d-val" id="repStaked">---</div>
                        </div>

                        <div class="dash-row">
                            <div>
                                <div class="d-lbl">Total veTHE Equivalent Owned</div>
                                <div class="d-sub">Voting Power Share</div>
                            </div>
                            <div class="d-val" id="repVe">---</div>
                        </div>

                        <div class="dash-row" style="border-bottom: none;">
                            <div>
                                <div class="d-lbl">Total Treasury Value</div>
                                <div class="d-sub">Estimated USD</div>
                            </div>
                            <div class="d-val" style="color:var(--accent-green); font-size:18px;">
                                $100.00
                                <span id="repClaimable" style="display:none;"></span>
                            </div>
                        </div>
                    </div>

                    <div class="dash-card">
                        <div class="user-profile-header">
                            <div class="dash-card-title">User Holdings</div>
                            <div id="statusBadge" class="user-status disconnected">Not Connected</div>
                        </div>
                        
                        <div class="query-section">
                            <div class="query-toggle">
                                <input type="checkbox" id="chkQuery" onchange="toggleQueryInput()">
                                <label for="chkQuery">Query Address</label>
                            </div>
                            <div class="query-input-wrap" id="queryWrap">
                                <input type="text" id="queryInput" class="query-field" placeholder="Paste address 0x..." oninput="handleQuery()">
                            </div>
                        </div>

                        <div class="user-balance-section">
                            <div class="user-balance-lbl" id="balanceLabel">AVAILABLE BALANCE</div>
                            <div class="user-balance-big">
                                <span id="userWallet">0.00</span><span class="user-balance-sym">THESTRAT</span>
                            </div>
                        </div>

                        <div class="address-box" onclick="copyAddress()">
                            <span id="userAddrDisplay">0x...</span>
                            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="socials-row">
            <a href="#" class="social-link" target="_blank" title="Twitter">
                <div class="social-icon">
                    <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </div>
                <span class="social-text">Twitter</span>
            </a>
            <a href="#" class="social-link" target="_blank" title="Docs">
                <div class="social-icon">
                    <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                </div>
                <span class="social-text">Docs</span>
            </a>
            <a href="#" class="social-link" target="_blank" title="Telegram">
                <div class="social-icon">
                    <svg viewBox="0 0 24 24"><path d="M21.93 3.53c-.36-.45-1.03-.54-1.55-.34L3.43 10.15c-.68.27-.69 1.14-.02 1.41l4.5 1.77 1.48 4.79c.14.47.74.55 1.01.16l2.12-3.08 4.4 3.39c.5.39 1.25.13 1.38-.5l2.67-13.5c.09-.46-.39-.92-.94-1.06zm-4.32 2.62l-7.6 6.8-.75-3.3 8.35-3.5z"/></svg>
                </div>
                <span class="social-text">Telegram</span>
            </a>
        </div>

        <div class="built-on-row">
            <span class="built-text">Built on</span>
            <img src="https://thena.fi/favicon/apple-touch-icon.png" alt="Thena" class="thena-icon-sm">
            <span class="built-text">Thena</span>
        </div>
    </div>

 <script>
        const ADDR_ROUTER = "0xd4ae6eca985340dd434d38f470accce4dc78d109";
        const ADDR_THESTRAT = "0x0e5eb3a3c1cf4d46fDedAD88D481A284b0496B4C"; 
        const ADDR_FBOMB  = "0x74ccbe53F77b08632ce0CB91D3A545bF6B8E0979";
        const ADDR_WBNB   = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
        const ADDR_STAKING = "0x28aa4f9ffe21365473b64c161b566c3cdead0108"; 
        const BSC_RPC = "https://bsc-dataseed.binance.org/";

        const IMG_BOMB = "fBOMB_token_whiteblue_blackcircle.png";
        const IMG_THESTRAT = "thenastrat_token_logo_black.png";

        const MINIMAL_STRAT_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function balanceOf(address account) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)"
        ];

        const ROUTER_ABI = [
            "function getAmountsOut(uint amountIn, tuple(address from, address to, bool stable)[] memory routes) public view returns (uint[] memory amounts)",
            "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, tuple(address from, address to, bool stable)[] calldata routes, address to, uint deadline) external"
        ];
        
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function balanceOf(address account) external view returns (uint256)"
        ];
        
        const STAKING_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function earned(address account, address _rewardsToken) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)"
        ];

        let provider, signer, userAddr;
        let pair = null;
        let isBuy = false;
        let slippage = 0.5;
        let quoteTimeout = null;
        let chartInstance = null;
        let isDark = false;
        let queryTimeout = null;

        function toggleTheme() {
            isDark = !isDark;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            
            const btn = document.getElementById('themeBtn');
            if(isDark) {
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
            } else {
                btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
            }

            renderPriceChart();
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            const btnIdx = (t === 'swap') ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIdx].classList.add('active');
            document.getElementById(t + '-view').classList.add('active');
            if(t === 'dashboard') {
                updateDashboard();
                fetchUserStats();
                if(!chartInstance) renderPriceChart();
                else renderPriceChart(); 
            }
        }

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('open'); }
        function setSlip(val) { slippage = val; document.getElementById('customSlip').value = ""; updateSlipUI(); }
        function setCustomSlip() { const val = parseFloat(document.getElementById('customSlip').value); if(!isNaN(val)) slippage = val; updateSlipUI(); }
        function updateSlipUI() { 
            document.querySelectorAll('.slip-btn').forEach(b => {
                b.classList.toggle('active', parseFloat(b.innerText) === slippage && document.getElementById('customSlip').value === "");
            });
            document.getElementById('slipDisplay').innerText = slippage + "%";
            calc(); 
        }

        function copyAddress() {
            if(!userAddr) return alert("Connect Wallet first");
            navigator.clipboard.writeText(userAddr);
            alert("Address Copied!");
        }

        function toggleQueryInput() {
            const isChecked = document.getElementById('chkQuery').checked;
            const wrap = document.getElementById('queryWrap');
            if(isChecked) {
                wrap.classList.add('show');
                document.getElementById('balanceLabel').innerText = "QUERY BALANCE";
                document.getElementById('userWallet').innerText = "0.00";
            } else {
                wrap.classList.remove('show');
                document.getElementById('queryInput').value = ""; 
                document.getElementById('balanceLabel').innerText = "AVAILABLE BALANCE";
                fetchUserStats(); 
            }
        }

        function handleQuery() {
            clearTimeout(queryTimeout);
            queryTimeout = setTimeout(() => {
                fetchUserStats();
            }, 500);
        }

        async function connectWallet() {
            if(!window.ethereum) return alert("Please install MetaMask!");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddr = await signer.getAddress();
                
                const net = await provider.getNetwork();
                if(net.chainId !== 56n) {
                    try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] }); }
                    catch(e) { return alert("Switch to BSC"); }
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                document.getElementById('connectBtn').innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
                document.getElementById('mainActionBtn').innerText = "SWAP";
                
                document.getElementById('statusBadge').innerText = "Active";
                document.getElementById('statusBadge').classList.remove('disconnected');
                document.getElementById('statusBadge').style.background = "#00aa00";
                document.getElementById('userAddrDisplay').innerText = userAddr.substring(0,8) + "..." + userAddr.substring(36);

                calc();
                updateDashboard();
                fetchSwapBalances(); 
                
                if(document.getElementById('chkQuery').checked) {
                    handleQuery(); 
                } else {
                    fetchUserStats();
                }
            } catch (e) { console.error(e); }
        }

        async function init() {
            document.getElementById('cardDate').innerText = new Date().toLocaleString();
            try {
                if(!provider) provider = new ethers.JsonRpcProvider(BSC_RPC);
                updateDashboard();
            } catch(e) { console.log("Init RPC error:", e); }

            try {
                const res = await fetch("https://api.dexscreener.com/latest/dex/search?q=fbomb%20ethena");
                const data = await res.json();
                if(data.pairs && data.pairs.length) {
                    pair = data.pairs[0];
                    pair.baseToken.symbol = "THESTRAT"; 
                    updateAllUI();
                    renderPriceChart();
                }
            } catch(e) {}
        }

        async function updateDashboard() {
            if(!provider) return;
            try {
                const stakingContract = new ethers.Contract(ADDR_STAKING, STAKING_ABI, provider);
                const wbnbContract = new ethers.Contract(ADDR_WBNB, ERC20_ABI, provider);
                try {
                    const totalSupplyWei = await stakingContract.totalSupply();
                    const totalSupFmt = parseFloat(ethers.formatUnits(totalSupplyWei, 18)).toLocaleString(undefined, {maximumFractionDigits:0});
                    document.getElementById('repStaked').innerHTML = totalSupFmt + '<span class="d-unit">eTHENA</span>';
                    document.getElementById('repVe').innerHTML = totalSupFmt + '<span class="d-unit">veTHE</span>';
                } catch(e) {
                    document.getElementById('repStaked').innerHTML = "---";
                    document.getElementById('repVe').innerHTML = "---";
                }
                const wbnbWei = await wbnbContract.balanceOf(ADDR_STAKING);
                const wbnbFmt = parseFloat(ethers.formatUnits(wbnbWei, 18)).toFixed(4);
                document.getElementById('repClaimable').innerHTML = wbnbFmt + '<span class="d-unit">WBNB</span>';
            } catch(e) { console.error("Dashboard Update Error:", e); }
        }

        function renderPriceChart() {
            if(chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            const style = getComputedStyle(document.documentElement);
            const lineColor = style.getPropertyValue('--text-main').trim();
            const gridColor = style.getPropertyValue('--chart-grid').trim();
            const textColor = style.getPropertyValue('--text-sub').trim();

            let currentPrice = pair ? parseFloat(pair.priceUsd) : 0.1732;
            let dataPoints = [];
            let labels = [];
            let val = currentPrice * 0.85; 
            for(let i=0; i<30; i++) {
                labels.push("Day " + (i+1));
                let change = (Math.random() - 0.4) * (currentPrice * 0.05);
                val += change;
                if(i===29) val = currentPrice;
                dataPoints.push(val);
            }
            document.getElementById('dashPriceVal').innerText = "$" + currentPrice.toFixed(6);
            document.getElementById('dashPriceChg').innerText = "-1.74%"; 

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price',
                        data: dataPoints,
                        borderColor: lineColor,
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: true, mode: 'index', intersect: false } },
                    scales: {
                        x: { 
                            display: true, 
                            grid: { display: false }, 
                            ticks: { maxTicksLimit: 6, font:{family:'Courier Prime'}, color: textColor } 
                        },
                        y: { 
                            display: true, 
                            position:'right', 
                            grid: { color: gridColor }, 
                            ticks: { callback: function(value){ return '$' + value.toFixed(4); }, font:{family:'Courier Prime'}, color: textColor } 
                        }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        async function fetchUserStats() {
            if(!provider) return;

            const isQuery = document.getElementById('chkQuery').checked;
            let targetAddr = userAddr;

            if(isQuery) {
                const inputVal = document.getElementById('queryInput').value;
                if(ethers.isAddress(inputVal)) {
                    targetAddr = inputVal;
                    document.getElementById('userAddrDisplay').innerText = targetAddr.substring(0,8) + "..." + targetAddr.substring(36);
                } else {
                    document.getElementById('userWallet').innerText = "---";
                    return;
                }
            } else {
                if(!userAddr) return;
                document.getElementById('userAddrDisplay').innerText = userAddr.substring(0,8) + "..." + userAddr.substring(36);
            }

            try {
                const tokenContract = new ethers.Contract(ADDR_THESTRAT, MINIMAL_STRAT_ABI, provider);
                const walletWei = await tokenContract.balanceOf(targetAddr);
                document.getElementById('userWallet').innerText = parseFloat(ethers.formatUnits(walletWei, 18)).toFixed(2);
            } catch(e) { console.log("User stats error", e); }
        }

        async function fetchSwapBalances() {
            if(!userAddr || !provider) return;
            try {
                const tIn = isBuy ? ADDR_THESTRAT : ADDR_FBOMB;
                const tOut = isBuy ? ADDR_FBOMB : ADDR_THESTRAT;
                
                const cIn = new ethers.Contract(tIn, MINIMAL_STRAT_ABI, provider);
                const cOut = new ethers.Contract(tOut, MINIMAL_STRAT_ABI, provider);

                const [bIn, bOut] = await Promise.all([
                    cIn.balanceOf(userAddr),
                    cOut.balanceOf(userAddr)
                ]);

                const bInFmt = ethers.formatUnits(bIn, 18); 
                const bOutFmt = ethers.formatUnits(bOut, 18);

                document.getElementById('sBal').innerText = parseFloat(bInFmt).toFixed(4);
                document.getElementById('sBal').dataset.raw = bInFmt;
                document.getElementById('bBal').innerText = parseFloat(bOutFmt).toFixed(4);
            } catch(e) { console.log("Swap balance fetch error", e); }
        }

        function setMax() {
            const raw = document.getElementById('sBal').dataset.raw;
            if(raw) {
                document.getElementById('inpAmt').value = raw;
                calc();
            }
        }

        function updateAllUI() {
            if(!pair) return;
            document.getElementById('cardPair').innerText = `THESTRAT / ${pair.quoteToken.symbol}`;
            document.getElementById('cardPrice').innerText = "$" + parseFloat(pair.priceUsd).toFixed(4);
            const chg = pair.priceChange.h24;
            const chgEl = document.getElementById('cardChange');
            chgEl.innerText = (chg >= 0 ? "+" : "") + chg + "%";
            chgEl.style.color = chg >= 0 ? "var(--accent-green)" : "var(--accent-red)";
            
            document.getElementById('cardFdv').innerText = fmtUSD(pair.fdv);
            document.getElementById('cardLiq').innerText = fmtUSD(pair.liquidity.usd);
            document.getElementById('cTok1').innerText = "THESTRAT";
            document.getElementById('cVal1').innerText = fmtNum(pair.liquidity.base);
            document.getElementById('cTok2').innerText = pair.quoteToken.symbol;
            document.getElementById('cVal2').innerText = fmtNum(pair.liquidity.quote);
            
            document.getElementById('barMC').innerText = fmtUSD(pair.fdv);
            document.getElementById('barVol').innerText = fmtUSD(pair.volume.h24);
            document.getElementById('barChg').innerText = (chg >= 0 ? "+" : "") + chg + "%";
            document.getElementById('barChg').style.color = chg >= 0 ? "var(--accent-green)" : "var(--accent-red)";

            updateSwapInputs();
        }

        function updateSwapInputs() {
            const tBase = { sym: "THESTRAT", name: "THESTRAT", icon: IMG_THESTRAT };
            const tQuote = { sym: "fBOMB", name: "fBOMB", icon: IMG_BOMB };
            const tin = isBuy ? tBase : tQuote;
            const tout = isBuy ? tQuote : tBase;
            document.getElementById('sSym').innerText = tin.sym;
            document.getElementById('sName').innerText = tin.name;
            document.getElementById('sIcon').src = tin.icon;
            document.getElementById('bSym').innerText = tout.sym;
            document.getElementById('bName').innerText = tout.name;
            document.getElementById('bIcon').src = tout.icon;

          
            const helpBtn = document.getElementById('mobileInfoBtn');
            if (tin.sym === "fBOMB") {
                helpBtn.classList.add('show-btn');
            } else {
                helpBtn.classList.remove('show-btn');
            }

            fetchSwapBalances();
            calc();
        }

        function toggleSwap() {
            isBuy = !isBuy;
            document.getElementById('inpAmt').value = "";
            document.getElementById('outAmt').value = "";
            updateSwapInputs();
        }

        async function getBestRoute(amountInWei, tokenIn, tokenOut, routerContract) {
            const routeDir = [{ from: tokenIn, to: tokenOut, stable: false }];
            try { 
                const amounts = await routerContract.getAmountsOut(amountInWei, routeDir); 
                return { route: routeDir, amounts }; 
            } catch (e) {
                console.log("Direct route failed, checking reserves...");
            }
            
            const routeWbnb = [{ from: tokenIn, to: ADDR_WBNB, stable: false }, { from: ADDR_WBNB, to: tokenOut, stable: false }];
            try { 
                const amounts = await routerContract.getAmountsOut(amountInWei, routeWbnb); 
                return { route: routeWbnb, amounts }; 
            } catch (e) {}

            throw new Error("No Liquidity or Price Impact too High");
        }

        function calc() {
            const val = parseFloat(document.getElementById('inpAmt').value);
            if(!val || val<=0) {
                document.getElementById('outAmt').value = "";
                document.getElementById('quoteTxt').innerText = "---";
                document.getElementById('bUsd').innerHTML = "$0.00"; 
                document.getElementById('sUsd').innerHTML = "$0.00";
                return;
            }
            if(!provider) { document.getElementById('outAmt').placeholder = "Connect Wallet"; return; }
            
            clearTimeout(quoteTimeout);
quoteTimeout = setTimeout(async () => {
    try {
        const router = new ethers.Contract(ADDR_ROUTER, ROUTER_ABI, provider);
        const tokenIn = isBuy ? ADDR_THESTRAT : ADDR_FBOMB;
        const tokenOut = isBuy ? ADDR_FBOMB : ADDR_THESTRAT;
        const inAbi = (tokenIn === ADDR_THESTRAT) ? MINIMAL_STRAT_ABI : ERC20_ABI;
        const outAbi = (tokenOut === ADDR_THESTRAT) ? MINIMAL_STRAT_ABI : ERC20_ABI;
        const tokenContract = new ethers.Contract(tokenIn, inAbi, provider);
        const outContract = new ethers.Contract(tokenOut, outAbi, provider);
        const decimals = await tokenContract.decimals();
        const outDecimals = await outContract.decimals();
        const amountInWei = ethers.parseUnits(val.toString(), decimals);
        const res = await getBestRoute(amountInWei, tokenIn, tokenOut, router);
        
        const amountOutWei = res.amounts[res.amounts.length - 1];
        const rawAmtOut = parseFloat(ethers.formatUnits(amountOutWei, outDecimals));
        
        
        const slipFactor = (100 - slippage) / 100;
        const minReceived = rawAmtOut * slipFactor;
        
        document.getElementById('outAmt').value = minReceived.toFixed(6);

        
        const priceIn = isBuy ? parseFloat(pair.priceUsd) : (parseFloat(pair.priceUsd)/parseFloat(pair.priceNative));
        document.getElementById('sUsd').innerText = fmtUSD(val * priceIn);
        
        const priceOut = isBuy ? (parseFloat(pair.priceUsd)/parseFloat(pair.priceNative)) : parseFloat(pair.priceUsd);
        document.getElementById('bUsd').innerText = fmtUSD(minReceived * priceOut);

       
        document.getElementById('rateTxt').innerText = `1 ${isBuy?'THESTRAT':'fBOMB'} = ${(rawAmtOut/val).toFixed(4)} ${isBuy?'fBOMB':'THESTRAT'}`;
        document.getElementById('quoteTxt').innerText = minReceived.toFixed(6);

    } catch(e) { console.log(e); }
}, 500);
        }

        document.getElementById('mainActionBtn').addEventListener('click', async () => {
            if(!userAddr) return connectWallet();
            const btn = document.getElementById('mainActionBtn');
            const val = document.getElementById('inpAmt').value;
            if(!val) return alert("Enter Amount");
            btn.innerText = "PROCESSING...";
            btn.disabled = true;
            try {
                const tokenIn = isBuy ? ADDR_THESTRAT : ADDR_FBOMB;
                const tokenOut = isBuy ? ADDR_FBOMB : ADDR_THESTRAT;
                const inAbi = (tokenIn === ADDR_THESTRAT) ? MINIMAL_STRAT_ABI : ERC20_ABI;
                const tokenContract = new ethers.Contract(tokenIn, inAbi, signer);
                const routerContract = new ethers.Contract(ADDR_ROUTER, ROUTER_ABI, signer);
                const decimals = await tokenContract.decimals();
                const amountInWei = ethers.parseUnits(val.toString(), decimals);
                
                const allowance = await tokenContract.allowance(userAddr, ADDR_ROUTER);
                if(allowance < amountInWei) {
                    btn.innerText = "APPROVING...";
                    const txApp = await tokenContract.approve(ADDR_ROUTER, ethers.MaxUint256);
                    await txApp.wait();
                }

                btn.innerText = "SWAPPING...";
                const routeRes = await getBestRoute(amountInWei, tokenIn, tokenOut, routerContract);
                const expectedOut = routeRes.amounts[routeRes.amounts.length-1];
                
                const minOut = (expectedOut * BigInt((100 - slippage)*100)) / 10000n;
                const deadline = Math.floor(Date.now()/1000) + 600;

                const tx = await routerContract.swapExactTokensForTokensSupportingFeeOnTransferTokens(
                    amountInWei, minOut, routeRes.route, userAddr, deadline, { gasLimit: 500000 }
                );
                await tx.wait();
                alert("Swap Successful: " + tx.hash);
                
                fetchSwapBalances();
                calc();

            } catch(e) { 
                console.error(e); 
                if(e.message.includes("require(false)") || e.code === "CALL_EXCEPTION") {
                    alert("Swap Failed: Please increase Slippage (try 2-5%) via the settings gear icon.");
                } else {
                    alert("Swap Failed: " + (e.reason || e.message)); 
                }
            }
            btn.innerText = "SWAP";
            btn.disabled = false;
        });
		function toggleAds() {
    document.body.classList.toggle('show-ads');
    
    const btn = document.getElementById('mobileInfoBtn');
    if (document.body.classList.contains('show-ads')) {
        btn.innerText = "X";
        btn.style.color = "var(--accent-red)";
        btn.style.borderColor = "var(--accent-red)"; 
    } else {
        btn.innerText = "?";
        btn.style.color = "var(--text-sub)";
        btn.style.borderColor = "var(--text-sub)";
    }
}

document.addEventListener('click', function(e) {
    if (document.body.classList.contains('show-ads')) {
        if (!e.target.closest('#leftAdBox') && 
            !e.target.closest('#rightBadgeBox') && 
            !e.target.closest('#mobileInfoBtn')) {
            toggleAds();
        }
    }
});
function closeAd(id) {
        document.getElementById(id).style.display = 'none';
    }
        function fmtUSD(n) { return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n); }
        function fmtNum(n) { return new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(n); }

        init();
    </script>	
    <div id="leftAdBox" class="ad-box">
<div class="close-btn" onclick="toggleAds()">X</div>
        
        <div class="ad-crop-zone">
            <img src="https://thena.fi/favicon/apple-touch-icon.png" class="ad-watermark">
        </div>

        <div class="ad-body">
            <img src="fBOMB_token_whiteblue_blackcircle.png" class="ad-main-icon">
            <div class="ad-title">Don't have fBOMB on BNB?</div>
            
            <div class="ad-dropdown">
                <button class="ad-drop-btn">GET fBOMB <span>&#9660;</span></button>
                <div class="ad-drop-content">
                    <a href="https://thena.fi/swap?outputCurrency=0x74ccbe53F77b08632ce0CB91D3A545bF6B8E0979" target="_blank">BUY ON THENA</a>
                    <a href="https://mclb.org/bridge/fBomb" target="_blank">BRIDGE HERE</a>
                </div>
            </div>
        </div>

        <a href="https://mclb.org" target="_blank" class="ad-footer">
            <span class="ad-footer-lbl">by MCLB.org</span>
            <img src="https://mclb.org/assets/figma/mclb-logo.svg" alt="MCLB" class="mclb-logo">
        </a>
    </div>  
    <div id="rightBadgeBox" class="right-badge-box">            
    <a href="https://eliteness.network/ethena/" target="_blank" id="rightBadgeBox" class="float-badge">
        <div class="close-btn" onclick="event.preventDefault(); event.stopPropagation(); closeAd('rightBadgeBox')">X</div>
        
        <div class="float-badge-inner">
            <img src="https://ftm.guru/icons/eliteness.png" alt="" class="float-watermark">
            <img src="https://ftm.guru/icons/ethena.png" alt="eTHENA" class="float-icon">
            <div class="float-content">
                <span class="float-title">Powered by eTHENA</span>
                <span class="float-sub">by Eliteness Network</span>
            </div>
        </div>
    </a>
    </div>

</body>
</html>
