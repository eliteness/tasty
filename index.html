<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thena Strategy | Treasury</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;600;700&family=Merriweather:wght@700;900&display=swap');

        :root { --bg-body: #FFFFFF; --text-main: #000000; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }

        .header-row { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: transparent; }
        .logo-container { display: flex; align-items: center; gap: 15px; }
        .top-logo { height: 50px; width: auto; display: block; }
        .logo-text { font-family: 'Merriweather', serif; font-weight: 900; font-size: 24px; letter-spacing: 1px; line-height: 1; margin-top: 4px; }
        
        .connect-btn { 
            background: #fff; color: #000; 
            padding: 10px 24px; 
            border: 2px solid #000; 
            font-family: 'Courier Prime', monospace; 
            font-weight: 700; 
            cursor: pointer; 
            transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .connect-btn:hover { background: #000; color: #fff; transform: translateY(-2px); box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }

        .tab-container { display: flex; justify-content: center; gap: 0; margin-top: 20px; border-bottom: 2px solid #000; width: fit-content; margin: 20px auto 40px auto; }
        .tab-btn { background: #fff; border: 2px solid #000; border-bottom: none; padding: 10px 40px; font-family: 'Courier Prime', monospace; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 14px; margin: 0 5px; position: relative; top: 2px; transition: background 0.2s; }
        .tab-btn:hover { background: #f0f0f0; }
        .tab-btn.active { background: #000; color: #fff; }

        .main-container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px; flex: 1; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        .swap-view-grid { display: flex; justify-content: center; align-items: flex-start; gap: 50px; flex-wrap: wrap; }
        .swap-column { flex: 1; max-width: 450px; min-width: 320px; }
        .swap-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .swap-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 18px; }
        .settings-icon { cursor: pointer; width: 24px; height: 24px; transition: transform 0.3s ease; }
        .settings-icon:hover { transform: rotate(90deg); }

        .settings-panel { background: #f0f0f0; border: 2px solid #000; padding: 15px; margin-bottom: 15px; display: none; }
        .settings-panel.open { display: block; }
        .slip-label { font-family: 'Courier Prime', monospace; font-size: 12px; margin-bottom: 8px; font-weight: bold; }
        .slip-options { display: flex; gap: 8px; }
        .slip-btn { flex: 1; background: #fff; border: 1px solid #000; font-family: 'Courier Prime', monospace; font-size: 12px; padding: 6px; cursor: pointer; }
        .slip-btn.active { background: #000; color: #fff; }
        .slip-input { width: 60px; border: 1px solid #000; padding: 6px; font-family: 'Courier Prime', monospace; font-size: 12px; text-align: center; }

        .trade-box { background: #fff; border: 2px solid #000; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; height: 140px; position: relative; margin-bottom: 10px; }
        .trade-label { font-family: 'Courier Prime', monospace; font-size: 14px; margin-bottom: 10px; }
        .trade-content { display: flex; justify-content: space-between; align-items: center; }
        .token-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .token-icon { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #000; }
        .token-symbol { font-family: 'Merriweather', serif; font-weight: 900; font-size: 20px; }
        .token-name { font-family: 'Courier Prime', monospace; font-size: 11px; color: #555; }
        
        .input-amount { width: 100%; border: none; background: transparent; font-family: 'Merriweather', serif; font-size: 24px; font-weight: 900; text-align: right; outline: none; padding: 0; }
        .usd-value { font-family: 'Courier Prime', monospace; font-size: 12px; color: #555; text-align: right; margin-top: 4px; }
        
        .arrow-wrapper { position: relative; height: 20px; margin-bottom: 10px; }
        .swap-arrow-btn { width: 36px; height: 36px; background: #fff; border: 1px solid #000; border-radius: 50%; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 5; transition: transform 0.2s; }
        .swap-arrow-btn:hover { background: #000; color: #fff; transform: translate(-50%, -50%) rotate(180deg); }

        .receipt-area { font-family: 'Courier Prime', monospace; font-size: 11px; margin: 15px 0; border-top: 1px dashed #ccc; padding-top: 10px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        
        .action-btn { width: 100%; background: #fff; color: #000; border: 2px solid #000; padding: 16px; font-family: 'Merriweather', serif; font-weight: 900; font-size: 16px; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { background: #000; color: #fff; }
        .action-btn:disabled { background: #ccc !important; cursor: not-allowed; }

        .summary-column { flex: 1; max-width: 450px; min-width: 320px; }
        .info-card { border: 2px solid #000; background: #fff; padding: 30px; }
        .info-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .pair-label { font-family: 'Merriweather', serif; font-weight: 900; font-size: 22px; }
        .date-label { font-family: 'Courier Prime', monospace; font-size: 11px; margin-top: 6px; }
        .price-large { font-family: 'Merriweather', serif; font-weight: 900; font-size: 42px; text-align: right; line-height: 1; }
        .price-change { font-family: 'Courier Prime', monospace; font-size: 16px; text-align: right; color: #00aa00; margin-top: 8px; font-weight: bold; }
        .mini-grid { display: flex; gap: 15px; margin-bottom: 25px; }
        .mini-box { border: 1px solid #000; padding: 15px; flex: 1; }
        .mini-label { font-family: 'Courier Prime', monospace; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; font-weight: bold; }
        .mini-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 20px; }
        .dashed-line { border-top: 1px dashed #000; margin: 25px 0; }
        .comp-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 14px; text-transform: uppercase; margin-bottom: 15px; }
        .comp-row { margin-bottom: 16px; }
        .comp-text { display: flex; justify-content: space-between; font-family: 'Courier Prime', monospace; font-size: 12px; font-weight: 700; margin-bottom: 6px; }
        .comp-bar { width: 100%; height: 16px; border: 1px solid #000; background: #fff; padding: 2px; }
        .comp-fill { height: 100%; background: #000; width: 0%; transition: width 1s; }
        .comp-fill.striped { background: repeating-linear-gradient(45deg, #000, #000 2px, #fff 2px, #fff 6px); }

        .portfolio-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 30px; margin-top: 10px; }
        @media(max-width: 900px) { .portfolio-grid { grid-template-columns: 1fr; } }
        
        .column-stack { display: flex; flex-direction: column; gap: 30px; }

        .port-card { border: 2px solid #000; background: #fff; padding: 25px; display: flex; flex-direction: column; position: relative; }
        .port-title { font-family: 'Merriweather', serif; font-weight: 900; font-size: 18px; margin-bottom: 5px; }
        .port-sub { font-family: 'Courier Prime', monospace; font-size: 11px; color: #666; margin-bottom: 20px; }
        
        .chart-wrapper { 
            position: relative; 
            width: 100%; 
            height: 350px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-bottom: 20px;
        }
        .chart-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 0; pointer-events: none;
        }
        .overlay-num { font-family: 'Merriweather', serif; font-size: 56px; font-weight: 900; line-height: 1; }
        .overlay-sub { font-family: 'Courier Prime', monospace; font-size: 12px; color: #666; text-transform: uppercase; font-weight: bold; }
        .bd-list { margin-top: 10px; }
        .bd-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #ddd; }
        .bd-left { display: flex; align-items: center; gap: 10px; }
        .bd-color { width: 12px; height: 12px; border: 1px solid #000; }
        .bd-name { font-family: 'Courier Prime', monospace; font-size: 12px; font-weight: 700; }
        .bd-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 15px; }
        .report-row { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px dashed #ccc; }
        .report-row:last-child { border-bottom: none; }
        .rep-label { font-family: 'Courier Prime', monospace; font-weight: 700; font-size: 13px; color: #333; }
        .rep-val { font-family: 'Merriweather', serif; font-weight: 900; font-size: 22px; text-align: right; }
        .rep-unit { font-size: 14px; font-weight: 400; color: #777; margin-left: 5px; font-family: 'Inter', sans-serif; }
        .meta-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-family: 'Courier Prime', monospace; font-size: 12px; align-items: center; }
        .meta-row:last-child { margin-bottom: 0; }
        .addr-tag { background: #000; color: #fff; padding: 4px 8px; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .addr-tag:hover { opacity: 0.7; }
        .user-mode-row { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; font-family: 'Courier Prime', monospace; font-size: 11px; }
        .addr-input { width: 100%; padding: 8px; border: 1px solid #000; font-family: 'Courier Prime', monospace; margin-right: 5px; }
        .sm-btn { background: #000; color: #fff; border: none; padding: 8px 12px; cursor: pointer; font-family: 'Courier Prime', monospace; font-weight: bold; }
        .socials-row { padding: 30px 0; display: flex; justify-content: center; gap: 40px; align-items: center; }
        .social-link { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #000; gap: 8px; transition: transform 0.2s; }
        .social-link:hover { transform: translateY(-3px); }
        .social-icon svg { width: 28px; height: 28px; fill: currentColor; }
        .social-text { font-family: 'Courier Prime', monospace; font-weight: 700; font-size: 12px; text-transform: uppercase; }

        .built-on-row {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            padding: 20px 0 40px 0; opacity: 0.8; transition: opacity 0.3s;
        }
        .built-on-row:hover { opacity: 1; }
        .thena-icon-sm { width: 20px; height: 20px; display: block; }
        .built-text { font-family: 'Courier Prime', monospace; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

    </style>
</head>
<body>

    <div class="header-row">
        <div class="logo-container">
            <img src="thenastrat_token_logo_black.png" alt="THESTRAT" class="top-logo">
            <span class="logo-text">Thena Strategy</span>
        </div>
        
        <button id="connectBtn" class="connect-btn" onclick="connectWallet()">CONNECT WALLET</button>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('swap')">SWAP</button>
        <button class="tab-btn" onclick="switchTab('dashboard')">PORTFOLIO</button>
    </div>

    <div class="main-container">

        <div id="swap-view" class="view-section active">
            <div class="swap-view-grid">
                <div class="swap-column">
                    <div class="swap-header-row">
                        <div class="swap-title">Swap</div>
                        <div class="settings-icon" onclick="toggleSettings()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        </div>
                    </div>

                    <div id="settingsPanel" class="settings-panel">
                        <div class="slip-label">SLIPPAGE TOLERANCE</div>
                        <div class="slip-options">
                            <button class="slip-btn" onclick="setSlip(0.1)">0.1%</button>
                            <button class="slip-btn active" onclick="setSlip(0.5)">0.5%</button>
                            <button class="slip-btn" onclick="setSlip(1.0)">1.0%</button>
                            <input type="number" id="customSlip" class="slip-input" placeholder="Custom" oninput="setCustomSlip()">
                        </div>
                    </div>

                    <div class="trade-box">
                        <div class="trade-label">Sell</div>
                        <div class="trade-content">
                            <div class="token-info" onclick="setMode('sell')">
                                <img src="" id="sIcon" class="token-icon">
                                <div>
                                    <div class="token-symbol" id="sSym">---</div>
                                    <div class="token-name" id="sName">---</div>
                                </div>
                            </div>
                            <div style="text-align:right; width:50%;">
                                <input type="number" id="inpAmt" class="input-amount" placeholder="0" oninput="calc()">
                                <div class="usd-value" id="sUsd">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="arrow-wrapper">
                        <div class="swap-arrow-btn" onclick="toggleSwap()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                        </div>
                    </div>

                    <div class="trade-box">
                        <div class="trade-label">Buy</div>
                        <div class="trade-content">
                            <div class="token-info" onclick="setMode('buy')">
                                <img src="" id="bIcon" class="token-icon">
                                <div>
                                    <div class="token-symbol" id="bSym">---</div>
                                    <div class="token-name" id="bName">---</div>
                                </div>
                            </div>
                            <div style="text-align:right; width:50%;">
                                <input type="text" id="outAmt" class="input-amount" placeholder="0" readonly>
                                <div class="usd-value" id="bUsd">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="receipt-area">
                        <div class="receipt-row"><span>Slippage</span><span id="slipDisplay">0.5%</span></div>
                        <div class="receipt-row"><span>Rate</span><span id="rateTxt">---</span></div>
                        <div class="receipt-row"><span>Quote (Inc. Fees)</span><span id="quoteTxt">---</span></div>
                    </div>

                    <button id="mainActionBtn" class="action-btn">CONNECT WALLET</button>
                </div>

                <div class="summary-column">
                    <div class="info-card">
                        <div class="info-header">
                            <div>
                                <div class="pair-label" id="cardPair">... / ...</div>
                                <div class="date-label" id="cardDate">...</div>
                            </div>
                            <div>
                                <div class="price-large" id="cardPrice">$0.0000</div>
                                <div class="price-change" id="cardChange">+0.00%</div>
                            </div>
                        </div>

                        <div class="mini-grid">
                            <div class="mini-box">
                                <div class="mini-label">Market Cap</div>
                                <div class="mini-val" id="cardFdv">---</div>
                            </div>
                            <div class="mini-box">
                                <div class="mini-label">Liquidity USD</div>
                                <div class="mini-val" id="cardLiq">---</div>
                            </div>
                        </div>

                        <div class="dashed-line"></div>

                        <div class="comp-title">Pool Composition</div>
                        <div class="comp-row">
                            <div class="comp-text"><span id="cTok1">---</span><span id="cVal1">0</span></div>
                            <div class="comp-bar"><div class="comp-fill" id="cBar1" style="width:50%"></div></div>
                        </div>
                        <div class="comp-row">
                            <div class="comp-text"><span id="cTok2">---</span><span id="cVal2">0</span></div>
                            <div class="comp-bar"><div class="comp-fill striped" id="cBar2" style="width:50%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-view" class="view-section">
            <div class="portfolio-grid">                             
				<div class="column-stack">
                    
                    <div class="port-card">
                        <div class="port-title">Supply Distribution</div>
                        <div class="port-sub">Real-time On-Chain Allocation</div>
                        
                        <div class="chart-wrapper">
                            <canvas id="sunburstChart"></canvas>
                            <div class="chart-overlay">
                                <div class="overlay-num">1B</div>
                                <div class="overlay-sub">Initial Supply</div>
                            </div>
                        </div>

                        <div id="loadingIndicator" style="display:none; text-align:center; font-family:'Courier Prime'; font-size:11px; margin-bottom:10px;">Fetching balances...</div>
                        <div class="port-card">
                        <div class="port-title">Asset Profile</div>
                        <div class="port-sub">Contract Details</div>

                        <div class="meta-row">
                            <span>Token</span>
                            <span style="font-weight:bold;">THESTRAT</span>
                        </div>
                        <div class="meta-row">
                            <span>Total Supply</span>
                            <span style="font-weight:bold;" id="metaSupply">1,000,000,000</span>
                        </div>
                        <div class="meta-row">
                            <span>Transfer Tax</span>
                            <span style="font-weight:bold;" id="metaTax">Loading...</span>
                        </div>
                        <div class="meta-row" style="margin-top:10px; border-top:1px dashed #ccc; padding-top:8px;">
                            <span>Contract</span>
                            <span class="addr-tag" onclick="navigator.clipboard.writeText('0x0e5eb3a3c1cf4d46fDedAD88D481A284b0496B4C'); alert('Address Copied');">0x0e5e...6B4C</span>
                        </div>
                    </div>
                        <div class="bd-list" id="breakdownList">
						
                        </div>
                    </div>

                    

                </div>

                <div class="column-stack">
                    <div class="port-card">
                        <div class="port-title">Treasury Holdings</div>
                        <div class="port-sub">Protocol Owned Assets</div>

                        <div style="margin-top:10px;">
                            <div class="report-row">
                                <div>
                                    <div class="rep-label">eTHENA Owned</div>
                                    <div style="font-size:10px; color:#888; font-family:'Inter'; margin-top:4px;">Staked in Protocol</div>
                                </div>
                                <div class="rep-val" id="repStaked">Loading...</div>
                            </div>

                            <div class="report-row">
                                <div>
                                    <div class="rep-label">veTHE Equivalent</div>
                                    <div style="font-size:10px; color:#888; font-family:'Inter'; margin-top:4px;">Voting Power Share</div>
                                </div>
                                <div class="rep-val" id="repVe">Loading...</div>
                            </div>

                            <div class="report-row">
                                <div>
                                    <div class="rep-label">Claimable Rewards</div>
                                    <div style="font-size:10px; color:#888; font-family:'Inter'; margin-top:4px;">Pending WBNB</div>
                                </div>
                                <div class="rep-val" style="color:#00aa00;" id="repClaimable">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div class="port-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="port-title">My Position</div>
                            <div class="user-mode-row">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    <input type="checkbox" id="modeToggle" onchange="toggleTreasuryMode()"> Query Address
                                </label>
                            </div>
                        </div>
                        <div class="port-sub">Your personal performance in the strategy</div>

                        <div id="addrInputRow" style="display:none; margin-bottom: 20px; padding-bottom: 20px; border-bottom:1px dashed #ccc;">
                            <div style="display:flex; gap:0;">
                                <input type="text" id="targetAddr" class="addr-input" placeholder="0x...">
                                <button class="sm-btn" onclick="fetchUserStats()">LOAD</button>
                            </div>
                        </div>

                        <div class="report-row">
                            <div class="rep-label">User Staked</div>
                            <div class="rep-val" id="userStaked">0.00<span class="rep-unit">STRAT</span></div>
                        </div>
                        
                    </div>

                </div>
            </div>

            <div class="socials-row">
                <a href="#" class="social-link" target="_blank">
                    <div class="social-icon">
                        <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    </div>
                    <span class="social-text">Twitter</span>
                </a>
                
                <a href="#" class="social-link" target="_blank">
                    <div class="social-icon">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                    </div>
                    <span class="social-text">Docs</span>
                </a>

                <a href="#" class="social-link" target="_blank">
                    <div class="social-icon">
                        <svg viewBox="0 0 24 24"><path d="M21.93 3.53c-.36-.45-1.03-.54-1.55-.34L3.43 10.15c-.68.27-.69 1.14-.02 1.41l4.5 1.77 1.48 4.79c.14.47.74.55 1.01.16l2.12-3.08 4.4 3.39c.5.39 1.25.13 1.38-.5l2.67-13.5c.09-.46-.39-.92-.94-1.06zm-4.32 2.62l-7.6 6.8-.75-3.3 8.35-3.5z"/></svg>
                    </div>
                    <span class="social-text">Telegram</span>
                </a>
            </div>

            <div class="built-on-row">
                <span class="built-text">Built on</span>
                <img src="https://thena.fi/favicon/apple-touch-icon.png" alt="Thena" class="thena-icon-sm">
                <span class="built-text">Thena</span>
            </div>
        </div>

    </div>

 <script>
        const ADDR_ROUTER = "0xd4ae6eca985340dd434d38f470accce4dc78d109";
        const ADDR_THESTRAT = "0x0e5eb3a3c1cf4d46fDedAD88D481A284b0496B4C"; 
        const ADDR_FBOMB  = "0x74ccbe53F77b08632ce0CB91D3A545bF6B8E0979";
        const ADDR_WBNB   = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
  
        const ADDR_STAKING = "0x28aa4f9ffe21365473b64c161b566c3cdead0108"; 
        
        const ADDR_MULTICALL = "0xcA11bde05977b3631167028862bE2a173976CA11";

        const BSC_RPC = "https://bsc-dataseed.binance.org/";

        const IMG_BOMB = "https://thena.fi/_next/image?url=https%3A%2F%2Fcdn.thena.fi%2Flogos%2FfBOMB.png&w=1920&q=75&dpl=dpl_6GpgTuCCNC4xHwdbe5brB6yEqQX5";
        const IMG_THESTRAT = "thenastrat_token_logo_black.png";

        const HOLDERS_CONFIG = [
            { label: "Treasury / LP", address: "0x28aa4f9ffe21365473b64c161b566c3cdead0108", group: "Liquidity", color: "#000000" },
        ];
        const TOTAL_SUPPLY = 1000000000; 

        const MINIMAL_STRAT_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function balanceOf(address account) external view returns (uint256)",
            "function totalSupply() external view returns (uint256)",
            "function taxRate() external view returns (uint256)",
            "function BP_DENOMINATOR() external view returns (uint256)"
        ];

        const ROUTER_ABI = [
            "function getAmountsOut(uint amountIn, tuple(address from, address to, bool stable)[] memory routes) public view returns (uint[] memory amounts)",
            "function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, tuple(address from, address to, bool stable)[] calldata routes, address to, uint deadline) external"
        ];
        
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function decimals() external view returns (uint8)",
            "function balanceOf(address account) external view returns (uint256)"
        ];
        
        const STAKING_ABI = [
            "function balanceOf(address account) external view returns (uint256)",
            "function earned(address account, address _rewardsToken) external view returns (uint256)",
            "function earnings(address account, address _rewardsToken) external view returns (uint256)", 
            "function totalSupply() external view returns (uint256)",
            "function tvl() external view returns (uint256)"
        ];

        const MULTICALL_ABI = [
            "function aggregate(tuple(address target, bytes callData)[] calls) public view returns (uint256 blockNumber, bytes[] returnData)"
        ];

        let provider, signer, userAddr;
        let pair = null;
        let isBuy = true;
        let slippage = 0.5;
        let quoteTimeout = null;
        let chartInstance = null;

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            const btnIdx = (t === 'swap') ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIdx].classList.add('active');
            document.getElementById(t + '-view').classList.add('active');
            if(t === 'dashboard') {
                updateDashboard();
                fetchPortfolioBalances(); 
                fetchUserStats();
            }
        }

        function toggleSettings() { document.getElementById('settingsPanel').classList.toggle('open'); }
        function setSlip(val) { slippage = val; document.getElementById('customSlip').value = ""; updateSlipUI(); }
        function setCustomSlip() { const val = parseFloat(document.getElementById('customSlip').value); if(!isNaN(val)) slippage = val; updateSlipUI(); }
        function updateSlipUI() { 
            document.querySelectorAll('.slip-btn').forEach(b => {
                b.classList.toggle('active', parseFloat(b.innerText) === slippage && document.getElementById('customSlip').value === "");
            });
            document.getElementById('slipDisplay').innerText = slippage + "%";
            calc(); 
        }

        function toggleTreasuryMode() {
            const chk = document.getElementById('modeToggle');
            document.getElementById('addrInputRow').style.display = chk.checked ? 'block' : 'none';
            if(!chk.checked && userAddr) fetchUserStats();
        }

        async function connectWallet() {
            if(!window.ethereum) return alert("Please install MetaMask!");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddr = await signer.getAddress();
                
                const net = await provider.getNetwork();
                if(net.chainId !== 56n) {
                    try { await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x38' }] }); }
                    catch(e) { return alert("Switch to BSC"); }
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                document.getElementById('connectBtn').innerText = userAddr.substring(0,6) + "..." + userAddr.substring(38);
                document.getElementById('mainActionBtn').innerText = "SWAP";
                calc();
                updateDashboard();
                fetchUserStats();
            } catch (e) { console.error(e); }
        }

        async function init() {
            document.getElementById('cardDate').innerText = new Date().toLocaleString();
            try {
                provider = new ethers.JsonRpcProvider(BSC_RPC);
                updateDashboard();
                fetchPortfolioBalances();
            } catch(e) { console.log("Init RPC error:", e); }

            try {
                const res = await fetch("https://api.dexscreener.com/latest/dex/search?q=fbomb%20ethena");
                const data = await res.json();
                if(data.pairs && data.pairs.length) {
                    pair = data.pairs[0];
                    pair.baseToken.symbol = "THESTRAT"; 
                    updateAllUI();
                }
            } catch(e) {}
        }

        async function updateDashboard() {
            if(!provider) return;
            
            try {
                const tokenContract = new ethers.Contract(ADDR_THESTRAT, MINIMAL_STRAT_ABI, provider);
                try {
                    const supplyWei = await tokenContract.totalSupply();
                    const supplyFmt = parseFloat(ethers.formatUnits(supplyWei, 18)).toLocaleString(undefined, {maximumFractionDigits:0});
                    document.getElementById('metaSupply').innerText = supplyFmt;
                } catch(e) {}

                try {
                    const taxRaw = await tokenContract.taxRate();
                    const taxPct = parseFloat(ethers.formatUnits(taxRaw, 18)) * 100;
                    document.getElementById('metaTax').innerText = taxPct.toFixed(0) + "%";
                } catch(e) { document.getElementById('metaTax').innerText = "10%"; }

                const stakingContract = new ethers.Contract(ADDR_STAKING, STAKING_ABI, provider);
                const wbnbContract = new ethers.Contract(ADDR_WBNB, ERC20_ABI, provider);

                try {
                    const totalSupplyWei = await stakingContract.totalSupply();
                    const totalSupFmt = parseFloat(ethers.formatUnits(totalSupplyWei, 18)).toLocaleString(undefined, {maximumFractionDigits:0});
                    document.getElementById('repStaked').innerHTML = totalSupFmt + '<span class="rep-unit">eTHENA</span>';
                    document.getElementById('repVe').innerHTML = totalSupFmt + '<span class="rep-unit">veTHE</span>';
                } catch(e) {
                    document.getElementById('repStaked').innerHTML = "---";
                    document.getElementById('repVe').innerHTML = "---";
                }

                const wbnbWei = await wbnbContract.balanceOf(ADDR_STAKING);
                const wbnbFmt = parseFloat(ethers.formatUnits(wbnbWei, 18)).toFixed(4);
                document.getElementById('repClaimable').innerHTML = wbnbFmt + '<span class="rep-unit">WBNB</span>';

            } catch(e) { console.error("Dashboard Update Error:", e); }
        }

        async function fetchPortfolioBalances() {
            if(!provider) return;
            document.getElementById('loadingIndicator').style.display = 'block';

            try {
                const mcContract = new ethers.Contract(ADDR_MULTICALL, MULTICALL_ABI, provider);
                const tokenInterface = new ethers.Interface(ERC20_ABI);

                const calls = HOLDERS_CONFIG.map(h => ({
                    target: ADDR_THESTRAT,
                    callData: tokenInterface.encodeFunctionData("balanceOf", [h.address])
                }));

                const result = await mcContract.aggregate(calls);
                const returnData = result[1];

                let totalKnown = 0;
                const fetchedData = HOLDERS_CONFIG.map((h, i) => {
                    const balanceWei = tokenInterface.decodeFunctionResult("balanceOf", returnData[i])[0];
                    const balance = parseFloat(ethers.formatUnits(balanceWei, 18)); 
                    totalKnown += balance;
                    return { ...h, amount: balance };
                });

                const publicAmt = TOTAL_SUPPLY - totalKnown;
                fetchedData.push({
                    label: "Remaining / Public",
                    amount: publicAmt > 0 ? publicAmt : 0,
                    group: "Public",
                    color: "#BBBBBB"
                });

                renderChart(fetchedData);

            } catch (e) { console.error("Multicall Error:", e); } 
            finally { document.getElementById('loadingIndicator').style.display = 'none'; }
        }

        function renderChart(data) {
            if(chartInstance) { chartInstance.destroy(); }

            const groups = {};
            data.forEach(item => {
                if(!groups[item.group]) groups[item.group] = 0;
                groups[item.group] += item.amount;
            });
            const groupData = Object.values(groups);
            const groupColors = ["#222", "#666", "#AAA"]; 

            const itemData = data.map(r => r.amount);
            const itemColors = data.map(r => r.color);

            const ctx = document.getElementById('sunburstChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(r => r.label),
                    datasets: [
                        {
                            data: itemData,
                            backgroundColor: itemColors,
                            borderWidth: 2, borderColor: '#fff', weight: 1.2
                        },
                        {
                            data: groupData,
                            backgroundColor: groupColors,
                            borderWidth: 2, borderColor: '#fff', weight: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '40%', 
                    plugins: { legend: { display: false } }
                }
            });

            const listEl = document.getElementById('breakdownList');
            listEl.innerHTML = "";
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = "bd-item";
                div.innerHTML = `
                    <div class="bd-left">
                        <div class="bd-color" style="background:${item.color}"></div>
                        <div class="bd-name">${item.label}</div>
                    </div>
                    <div class="bd-val">${fmtNum(item.amount)}</div>
                `;
                listEl.appendChild(div);
            });
        }

        async function fetchUserStats() {
            if(!provider) return;
            const useCustom = document.getElementById('modeToggle').checked;
            let target = userAddr;
            if(useCustom) {
                const inp = document.getElementById('targetAddr').value;
                if(ethers.isAddress(inp)) target = inp;
            }
            if(!target) return;

            try {
                const stakingContract = new ethers.Contract(ADDR_STAKING, STAKING_ABI, provider);
                
                const stakedWei = await stakingContract.balanceOf(target);
                document.getElementById('userStaked').innerHTML = parseFloat(ethers.formatUnits(stakedWei, 18)).toFixed(2) + '<span class="rep-unit">STRAT</span>';
                
            } catch(e) { console.log("User stats error", e); }
        }

        function updateAllUI() {
            if(!pair) return;
            document.getElementById('cardPair').innerText = `THESTRAT / ${pair.quoteToken.symbol}`;
            document.getElementById('cardPrice').innerText = "$" + parseFloat(pair.priceUsd).toFixed(4);
            const chg = pair.priceChange.h24;
            const chgEl = document.getElementById('cardChange');
            chgEl.innerText = (chg >= 0 ? "+" : "") + chg + "%";
            chgEl.style.color = chg >= 0 ? "#00aa00" : "#cc0000";
            
            document.getElementById('cardFdv').innerText = fmtUSD(pair.fdv);
            document.getElementById('cardLiq').innerText = fmtUSD(pair.liquidity.usd);
            document.getElementById('cTok1').innerText = "THESTRAT";
            document.getElementById('cVal1').innerText = fmtNum(pair.liquidity.base);
            document.getElementById('cTok2').innerText = pair.quoteToken.symbol;
            document.getElementById('cVal2').innerText = fmtNum(pair.liquidity.quote);
            updateSwapInputs();
        }

        function updateSwapInputs() {
            const tBase = { sym: "THESTRAT", name: "THESTRAT", icon: IMG_THESTRAT };
            const tQuote = { sym: "fBOMB", name: "fBOMB", icon: IMG_BOMB };
            const tin = isBuy ? tBase : tQuote;
            const tout = isBuy ? tQuote : tBase;
            document.getElementById('sSym').innerText = tin.sym;
            document.getElementById('sName').innerText = tin.name;
            document.getElementById('sIcon').src = tin.icon;
            document.getElementById('bSym').innerText = tout.sym;
            document.getElementById('bName').innerText = tout.name;
            document.getElementById('bIcon').src = tout.icon;
            calc();
        }

        function toggleSwap() {
            isBuy = !isBuy;
            document.getElementById('inpAmt').value = "";
            document.getElementById('outAmt').value = "";
            updateSwapInputs();
        }

        async function getBestRoute(amountInWei, tokenIn, tokenOut, routerContract) {
            const routeWbnb = [{ from: tokenIn, to: ADDR_WBNB, stable: false }, { from: ADDR_WBNB, to: tokenOut, stable: false }];
            try { const amounts = await routerContract.getAmountsOut(amountInWei, routeWbnb); return { route: routeWbnb, amounts }; } catch (e) {}
            const routeDir = [{ from: tokenIn, to: tokenOut, stable: false }];
            try { const amounts = await routerContract.getAmountsOut(amountInWei, routeDir); return { route: routeDir, amounts }; } catch (e) {}
            throw new Error("No Liquidity");
        }

        function calc() {
            const val = parseFloat(document.getElementById('inpAmt').value);
            if(!val || val<=0) {
                document.getElementById('outAmt').value = "";
                document.getElementById('quoteTxt').innerText = "---";
                document.getElementById('bUsd').innerHTML = "$0.00"; 
                return;
            }
            if(!provider) { document.getElementById('outAmt').placeholder = "Connect Wallet"; return; }
            
            clearTimeout(quoteTimeout);
            quoteTimeout = setTimeout(async () => {
                try {
                    const router = new ethers.Contract(ADDR_ROUTER, ROUTER_ABI, provider);
                    const tokenIn = isBuy ? ADDR_THESTRAT : ADDR_FBOMB;
                    const tokenOut = isBuy ? ADDR_FBOMB : ADDR_THESTRAT;
                    
                    const inAbi = (tokenIn === ADDR_THESTRAT) ? MINIMAL_STRAT_ABI : ERC20_ABI;
                    const outAbi = (tokenOut === ADDR_THESTRAT) ? MINIMAL_STRAT_ABI : ERC20_ABI;

                    const tokenContract = new ethers.Contract(tokenIn, inAbi, provider);
                    const outContract = new ethers.Contract(tokenOut, outAbi, provider);
                    
                    const decimals = await tokenContract.decimals();
                    const outDecimals = await outContract.decimals();
                    const amountInWei = ethers.parseUnits(val.toString(), decimals);
                    
                    const res = await getBestRoute(amountInWei, tokenIn, tokenOut, router);
                    const amountOutWei = res.amounts[res.amounts.length - 1];
                    const amtOut = parseFloat(ethers.formatUnits(amountOutWei, outDecimals));
                    
                    document.getElementById('outAmt').value = amtOut.toFixed(6);
                    
                    const priceIn = isBuy ? parseFloat(pair.priceUsd) : (parseFloat(pair.priceUsd)/parseFloat(pair.priceNative));
                    document.getElementById('sUsd').innerText = fmtUSD(val * priceIn);
                    
                    const priceOut = isBuy ? (parseFloat(pair.priceUsd)/parseFloat(pair.priceNative)) : parseFloat(pair.priceUsd);
                    const valOutUsd = amtOut * priceOut;
                    document.getElementById('bUsd').innerText = fmtUSD(valOutUsd);
                    
                    document.getElementById('rateTxt').innerText = `1 ${isBuy?'STRAT':'BOMB'} = ${(amtOut/val).toFixed(4)} ${isBuy?'BOMB':'STRAT'}`;
                    document.getElementById('quoteTxt').innerText = amtOut.toFixed(6);
                } catch(e) { console.log(e); }
            }, 500);
        }

        document.getElementById('mainActionBtn').addEventListener('click', async () => {
            if(!userAddr) return connectWallet();
            const btn = document.getElementById('mainActionBtn');
            const val = document.getElementById('inpAmt').value;
            if(!val) return alert("Enter Amount");
            btn.innerText = "PROCESSING...";
            btn.disabled = true;
            try {
                const tokenIn = isBuy ? ADDR_THESTRAT : ADDR_FBOMB;
                const tokenOut = isBuy ? ADDR_FBOMB : ADDR_THESTRAT;
                
                const inAbi = (tokenIn === ADDR_THESTRAT) ? MINIMAL_STRAT_ABI : ERC20_ABI;
                const tokenContract = new ethers.Contract(tokenIn, inAbi, signer);
                const routerContract = new ethers.Contract(ADDR_ROUTER, ROUTER_ABI, signer);
                
                const decimals = await tokenContract.decimals();
                const amountInWei = ethers.parseUnits(val.toString(), decimals);
                
                const allowance = await tokenContract.allowance(userAddr, ADDR_ROUTER);
                if(allowance < amountInWei) {
                    btn.innerText = "APPROVING...";
                    const txApp = await tokenContract.approve(ADDR_ROUTER, ethers.MaxUint256);
                    await txApp.wait();
                }
                btn.innerText = "SWAPPING...";
                const routeRes = await getBestRoute(amountInWei, tokenIn, tokenOut, routerContract);
                const expectedOut = routeRes.amounts[routeRes.amounts.length-1];
                const minOut = (expectedOut * BigInt((100 - slippage)*100)) / 10000n;
                const deadline = Math.floor(Date.now()/1000) + 600;
                const tx = await routerContract.swapExactTokensForTokensSupportingFeeOnTransferTokens(
                    amountInWei, minOut, routeRes.route, userAddr, deadline
                );
                await tx.wait();
                alert("Swap Successful: " + tx.hash);
                calc();
            } catch(e) { console.error(e); alert("Swap Failed: " + (e.reason || e.message)); }
            btn.innerText = "SWAP";
            btn.disabled = false;
        });

        function fmtUSD(n) { return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n); }
        function fmtNum(n) { return new Intl.NumberFormat('en-US',{maximumFractionDigits:0}).format(n); }

        init();
    </script>
</body>
</html>
